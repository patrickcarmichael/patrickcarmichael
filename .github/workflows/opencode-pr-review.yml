name: OpenCode PR Review

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install OpenCode
        run: npm install -g opencode-ai

      - name: Bootstrap OpenCode auth
        run: |
          mkdir -p ~/.local/share/opencode
          cat > ~/.local/share/opencode/auth.json <<'JSON'
          ${{ secrets.OPENCODE_AUTH }}
          JSON

      - name: Generate review
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
          PR_HEAD: ${{ github.event.pull_request.head.ref }}
        run: |
          opencode run --agent oracle "Review pull request #${PR_NUMBER} titled '${PR_TITLE}'. Compare ${PR_BASE}...${PR_HEAD}. Return concise markdown with sections: Summary, Risks, Suggested Changes, Test Plan." > opencode-pr-review.md

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: gh pr comment "$PR_NUMBER" --body-file opencode-pr-review.md
